---
sidebar_position: 4
description: è¾…åŠ©æ¨¡å‹
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# è¾…åŠ©åŠŸèƒ½

`uniseg` æ¨¡å—åŒæ—¶æä¾›äº†å¤šç§æ–¹æ³•ä»¥é€šç”¨æ¶ˆæ¯æ“ä½œã€‚

:::note

è¿™äº›æ–¹æ³•ä¸­ä¸ `event`, `bot` ç›¸å…³çš„å‚æ•°éƒ½ä¼šå°è¯•ä»ä¸Šä¸‹æ–‡ä¸­è·å–å¯¹è±¡ã€‚

:::

## æ¶ˆæ¯äº‹ä»¶ ID

æ¶ˆæ¯äº‹ä»¶ ID æ˜¯ç”¨æ¥æ ‡è¯†å½“å‰æ¶ˆæ¯äº‹ä»¶çš„å”¯ä¸€ IDï¼Œé€šå¸¸ç”¨äºå›å¤/æ’¤å›/ç¼–è¾‘/è¡¨æ€å½“å‰æ¶ˆæ¯ã€‚

<Tabs groupId="get_msgid">
<TabItem value="depend" label="ä½¿ç”¨ä¾èµ–æ³¨å…¥">

é€šè¿‡æä¾›çš„ `MessageId` æˆ– `MsgId` ä¾èµ–æ³¨å…¥å™¨æ¥è·å–æ¶ˆæ¯äº‹ä»¶ idã€‚

```python
from nonebot_plugin_alconna.uniseg import MsgId


matcher = on_xxx(...)

@matcher.handle()
asycn def _(msg_id: MsgId):
    ...
```

</TabItem>
<TabItem value="method" label="ä½¿ç”¨è·å–å‡½æ•°">

```python
from nonebot import Event, Bot
from nonebot_plugin_alconna.uniseg import get_message_id


matcher = on_xxx(...)

@matcher.handle()
asycn def _(bot: Bot, event: Event):
    msg_id: str = get_message_id(event, bot)

```

</TabItem>
</Tabs>

:::caution

è¯¥æ–¹æ³•è·å–çš„æ¶ˆæ¯äº‹ä»¶ ID ä¸æ¨èç›´æ¥ç”¨äºå„é€‚é…å™¨çš„ API è°ƒç”¨ä¸­ï¼Œå¯èƒ½ä¼šæ“ä½œå¤±è´¥ã€‚

:::

## å‘é€å¯¹è±¡

æ¶ˆæ¯å‘é€å¯¹è±¡æ˜¯ç”¨æ¥æè¿°å½“å‰æ¶ˆæ¯äº‹ä»¶çš„å¯å‘é€å¯¹è±¡æˆ–è€…ä¸»åŠ¨å‘é€æ¶ˆæ¯æ—¶çš„ç›®æ ‡å¯¹è±¡ï¼Œå®ƒåŒ…å«äº†ä»¥ä¸‹å±æ€§ï¼š

```python
class Target:
    id: str
    """ç›®æ ‡idï¼›è‹¥ä¸ºç¾¤èŠåˆ™ä¸º group_id æˆ–è€… channel_idï¼Œè‹¥ä¸ºç§èŠåˆ™ä¸º user_id"""
    parent_id: str
    """çˆ¶çº§idï¼›è‹¥ä¸ºé¢‘é“åˆ™ä¸º guild_idï¼Œå…¶ä»–æƒ…å†µä¸‹å¯èƒ½ä¸ºç©ºå­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ Feishu ä¸‹å¯ä½œä¸ºéƒ¨é—¨ idï¼‰"""
    channel: bool
    """æ˜¯å¦ä¸ºé¢‘é“ï¼Œä»…å½“ç›®æ ‡å¹³å°ç¬¦åˆé¢‘é“æ¦‚å¿µæ—¶"""
    private: bool
    """æ˜¯å¦ä¸ºç§èŠ"""
    source: str
    """å¯èƒ½çš„äº‹ä»¶id"""
    self_id: str | None
    """æœºå™¨äººidï¼Œè‹¥ä¸º None åˆ™ Bot å¯¹è±¡ä¼šéšæœºé€‰æ‹©"""
    selector: Callable[[Bot], Awaitable[bool]] | None
    """é€‰æ‹©å™¨ï¼Œç”¨äºåœ¨å¤šä¸ª Bot å¯¹è±¡ä¸­é€‰æ‹©ç‰¹å®š Bot"""
    extra: dict[str, Any]
    """é¢å¤–ä¿¡æ¯ï¼Œç”¨äºé€‚é…å™¨æ‰©å±•"""
```

<Tabs groupId="get_target">
<TabItem value="depend" label="ä½¿ç”¨ä¾èµ–æ³¨å…¥">

é€šè¿‡æä¾›çš„ `MessageTarget` æˆ– `MsgTarget` ä¾èµ–æ³¨å…¥å™¨æ¥è·å–æ¶ˆæ¯å‘é€å¯¹è±¡ã€‚

```python
from nonebot_plugin_alconna.uniseg import MsgTarget


matcher = on_xxx(...)

@matcher.handle()
asycn def _(target: MsgTarget):
    ...
```

</TabItem>
<TabItem value="method" label="ä½¿ç”¨è·å–å‡½æ•°">

```python
from nonebot import Event, Bot
from nonebot_plugin_alconna.uniseg import Target, get_target


matcher = on_xxx(...)

@matcher.handle()
asycn def _(bot: Bot, event: Event):
    target: Target = get_target(event, bot)

```

</TabItem>
</Tabs>

ä¸»åŠ¨æ„é€ ä¸€ä¸ªå‘é€å¯¹è±¡æ—¶ï¼Œåˆ™éœ€è¦å¦‚ä¸‹å‚æ•°ï¼š

- `id`: ç›®æ ‡IDï¼›è‹¥ä¸ºç¾¤èŠåˆ™ä¸º `group_id` æˆ–è€… `channel_id`ï¼Œè‹¥ä¸ºç§èŠåˆ™ä¸º `user_id`
- `parent_id`: çˆ¶çº§IDï¼›è‹¥ä¸ºé¢‘é“åˆ™ä¸º `guild_id`ï¼Œå…¶ä»–æƒ…å†µä¸‹å¯èƒ½ä¸ºç©ºå­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ Feishu ä¸‹å¯ä½œä¸ºéƒ¨é—¨ idï¼‰
- `channel`: æ˜¯å¦ä¸ºé¢‘é“ï¼Œä»…å½“ç›®æ ‡å¹³å°ç¬¦åˆé¢‘é“æ¦‚å¿µæ—¶
- `private`: æ˜¯å¦ä¸ºç§èŠ
- `source`: å¯èƒ½çš„äº‹ä»¶ID
- `self_id`: æœºå™¨äººidï¼Œè‹¥ä¸º None åˆ™ Bot å¯¹è±¡ä¼šéšæœºé€‰æ‹©
- `selector`: é€‰æ‹©å™¨ï¼Œç”¨äºåœ¨å¤šä¸ª Bot å¯¹è±¡ä¸­é€‰æ‹©ç‰¹å®š Bot
- `scope`: å¹³å°èŒƒå›´ï¼Œè¡¨ç¤ºå½“å‰å‘é€å¯¹è±¡çš„å¹³å°ç±»åˆ«
- `adapter`: é€‚é…å™¨åç§°ï¼Œè‹¥ä¸º None åˆ™éœ€è¦æ˜ç¡®æŒ‡å®š Bot å¯¹è±¡
- `platform`: å¹³å°åç§°ï¼Œä»…å½“ç›®æ ‡é€‚é…å™¨å­˜åœ¨å¤šä¸ªå¹³å°æ—¶ä½¿ç”¨
- `extra`: é¢å¤–ä¿¡æ¯ï¼Œç”¨äºé€‚é…å™¨æ‰©å±•

é€šè¿‡ `Target` å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `UniMessage.send` ä¸­æŒ‡å®šå‘é€å¯¹è±¡ï¼š

```python
from nonebot_plugin_alconna.uniseg import UniMessage, MsgTarget, Target, SupportScope


matcher = on_xxx(...)

@matcher.handle()
async def _(target: MsgTarget):
    # å°†æ¶ˆæ¯å‘é€ç»™å½“å‰äº‹ä»¶çš„å‘é€è€…
    await UniMessage("Hello!").send(target=target)
    # ä¸»åŠ¨å‘é€æ¶ˆæ¯ç»™ç¾¤å·ä¸º 12345 çš„ QQ ç¾¤èŠ
    target1 = Target("12345", scope=SupportScope.qq_client)
    await UniMessage("Hello!").send(target=target1)
```

### é€‰æ‹©å™¨

ä¸€èˆ¬æ¥è¯´ï¼Œä¸»åŠ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œ`UniMessage.send` æˆ– `Target.self_id` åº”æŒ‡å®šä¸€ä¸ª `Bot` å¯¹è±¡ã€‚ä½†æ˜¯è¿™æ ·ä¼šåŠ é‡å¼€å‘è€…çš„è´Ÿæ‹…ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬æä¾›äº†é€‰æ‹©å™¨æ¥å¸®åŠ©å¼€å‘è€…é€‰æ‹©ä¸€ä¸ª `Bot` å¯¹è±¡ã€‚å½“ç„¶ï¼Œè¿™å¹¶éè¯´æ˜ä¸€å®šéœ€è¦ä¼ å…¥ `selector` å‚æ•°ã€‚

äº‹å®ä¸Šï¼Œæ„é€  `Target` å¯¹è±¡æ—¶ï¼Œ`self_id`, `scope`, `adapter` å’Œ `platform` éƒ½ä¼šå‚ä¸åˆ° `selector` çš„æ„é€ ä¸­ã€‚

:::tip

ä½ å…¶å®å¯ä»¥ä½¿ç”¨ `Target` æ¥å¸®ä½ ç­›é€‰ `Bot` å¯¹è±¡ï¼š

```python
async def _():
    target = Target("12345", scope=SupportScope.qq_client)
    bot = await target.select()
```

:::

è‹¥é…ç½®äº† [`alconna_apply_fetch_targets`](../config.md#alconna_apply_fetch_targets) é€‰é¡¹ï¼Œåˆ™åœ¨å¯åŠ¨æ—¶ä¼šä¸»åŠ¨æ‹‰å–ä¸€æ¬¡å‘é€å¯¹è±¡åˆ—è¡¨ã€‚å³å¯¹äº
æŸä¸€ä¸»åŠ¨æ„é€ çš„ `Target` å¯¹è±¡ï¼Œæ’ä»¶å°†å…¶ä¸æ‹‰å–ä¸‹æ¥çš„ä¼—å¤šå‘é€å¯¹è±¡è¿›è¡ŒåŒ¹é…ï¼Œå¹¶é€‰æ‹©ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„å‘é€å¯¹è±¡ï¼Œä»¥é€‰æ‹©å¯¹åº”çš„ Bot å¯¹è±¡ã€‚

## æ’¤å›æ¶ˆæ¯

é€šè¿‡ `message_recall` æ–¹æ³•æ¥æ’¤å›æ¶ˆæ¯äº‹ä»¶ã€‚

```python
from nonebot_plugin_alconna.uniseg import message_recall

matcher = on_xxx(...)

@matcher.handle()
async def _(msg_id: MsgId):
    await message_recall(msg_id)
```

`message_recall` æ–¹æ³•çš„å‚æ•°å¦‚ä¸‹ï¼š

```python
async def message_recall(
    message_id: str | None = None,
    event: Event | None = None,
    bot: Bot | None = None,
    adapter: str | None = None
): ...
```

å½“ `message_id` ä¸º `None` æ—¶ï¼Œæ’ä»¶ä¼šå°è¯•ä» `event` ä¸­è·å–æ¶ˆæ¯äº‹ä»¶ IDã€‚

## ç¼–è¾‘æ¶ˆæ¯

é€šè¿‡ `message_edit` æ–¹æ³•æ¥ç¼–è¾‘æ¶ˆæ¯äº‹ä»¶ã€‚

```python
from nonebot_plugin_alconna.uniseg import UniMessage, message_edit

matcher = on_xxx(...)

@matcher.handle()
async def _():
    await message_edit(UniMessage.text("1234"))
```

`message_edit` æ–¹æ³•çš„å‚æ•°å¦‚ä¸‹ï¼š

```python
async def message_edit(
    msg: UniMessage,
    message_id: str | None = None,
    event: Event | None = None,
    bot: Bot | None = None,
    adapter: str | None = None,
): ...
```

å½“ `message_id` ä¸º `None` æ—¶ï¼Œæ’ä»¶ä¼šå°è¯•ä» `event` ä¸­è·å–æ¶ˆæ¯äº‹ä»¶ IDã€‚

## è¡¨æ€æ¶ˆæ¯

:::caution

è¯¥æ–¹æ³•å±äºå®éªŒæ€§åŠŸèƒ½ã€‚å…¶æ¥å£å¯èƒ½ä¼šåœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­å‘ç”Ÿå˜åŒ–ã€‚

:::

é€šè¿‡ `message_reaction` æ–¹æ³•æ¥è¡¨æ€æ¶ˆæ¯äº‹ä»¶ã€‚

```python
from nonebot_plugin_alconna.uniseg import message_reaction

matcher = on_xxx(...)

@matcher.handle()
async def _():
    await message_reaction("ğŸ‘")
```

`message_reaction` æ–¹æ³•çš„å‚æ•°å¦‚ä¸‹ï¼š

```python
async def message_reaction(
    reaction: str | Emoji,
    message_id: str | None = None,
    event: Event | None = None,
    bot: Bot | None = None,
    adapter: str | None = None,
    delete: bool = False,
): ...
```

å½“ `message_id` ä¸º `None` æ—¶ï¼Œæ’ä»¶ä¼šå°è¯•ä» `event` ä¸­è·å–æ¶ˆæ¯äº‹ä»¶ IDã€‚

`delete` å‚æ•°è¡¨ç¤ºæ˜¯å¦åˆ é™¤**è‡ªå·±çš„**è¡¨æ€æ¶ˆæ¯ï¼Œé»˜è®¤ä¸º `False`ã€‚

## å“åº”è§„åˆ™

`uniseg` æ¨¡å—æä¾›äº†ä¸¤ä¸ªå“åº”è§„åˆ™ï¼š

- `at_in`: æ˜¯å¦åœ¨æ¶ˆæ¯ä¸­ @ äº†æŒ‡å®šçš„ç”¨æˆ·
- `at_me`: æ˜¯å¦åœ¨æ¶ˆæ¯ä¸­ @ äº†æœºå™¨äºº

ç›¸è¾ƒäº NoneBot å†…ç½®çš„ `to_me` è§„åˆ™ï¼Œ`at_me` è§„åˆ™åªä¼šåœ¨æ¶ˆæ¯ä¸­ @ æœºå™¨äººæ—¶è§¦å‘ã€‚

```python
from nonebot_plugin_alconna.uniseg import at_me

matcher = on_xxx(..., rule=at_me())
```
