---
sidebar_position: 1
description: 单元测试概览
slug: /advanced/unittest/

options:
  menu:
    weight: 80
    category: advanced
---

import CodeBlock from "@theme/CodeBlock";
import WeatherSource from "!!raw-loader!@site/../tests/examples/weather.py";
import WeatherTest from "!!raw-loader!@site/../tests/test_examples/test_weather.py";

# 单元测试

[单元测试](https://zh.wikipedia.org/wiki/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95)

> 在计算机编程中，单元测试（Unit Testing）又称为模块测试，是针对程序模块（软件设计的最小单位）来进行正确性检验的测试工作。

NoneBot2 使用 [Pytest](https://docs.pytest.org) 单元测试框架搭配 [NoneBug](https://github.com/nonebot/nonebug) 插件进行单元测试，通过直接与事件响应器/适配器等交互简化测试流程，更易于编写。

## 安装NoneBug

安装 NoneBug 时，Pytest 会作为依赖被一起安装。

要运行 NoneBug，还需要额外安装 Pytest 异步插件 `pytest-asyncio` 或 `anyio`，文档将以 `pytest-asyncio` 为例。

```bash
pip install nonebug pytest-asyncio
# 也可以通过 Poetry 安装
poetry add nonebug pytest-asyncio --dev
```
## 加载插件

我们可以使用 Pytest **Fixtures** 来加载插件，下面是一个示例。

:::tip 提示

建议阅读 [Pytest 文档](https://docs.pytest.org) 理解相关术语。

此 Fixture 的 [`nonebug_init`](https://github.com/nonebot/nonebug/blob/master/nonebug/fixture.py) 形参也是一个 Fixture，用于初始化 NoneBot。

将目录 `str(Path(__file__).parent / "examples")` 替换为待测试插件所在目录。

Fixture 名称 `load_example` 可以修改为其他名称，文档以 `load_example` 为例。

:::

```python title=conftest.py
from pathlib import Path
from typing import TYPE_CHECKING, Set

import pytest

if TYPE_CHECKING:
    from nonebot.plugin import Plugin


@pytest.fixture
def load_example(nonebug_init: None) -> Set["Plugin"]:
    import nonebot  # 这里的导入必须在函数内

    # 加载插件
    return nonebot.load_plugins(str(Path(__file__).parent / "examples"))
```

这样返回的就是 `examples` 目录加载后的插件，需要加载插件时，在测试函数添加形参 `load_example` 即可。

加载完成后即可使用 `import` 导入事件响应器。

## 编写测试用例

:::tip 提示

将从 `utils` 导入的 `make_fake_message`，`make_fake_event` 替换为对应平台的消息/事件类型。

这里的 `app` 是 Fixture [`nonebug_app`](https://github.com/nonebot/nonebug/blob/master/nonebug/fixture.py) 的别名，用于初始化 NoneBot 并返回 `App` 对象。

:::

:::warning 警告

所有从 `nonebot` 导入模块的函数都需要首先初始化 NoneBot，否则会发生不可预料的问题。

:::

使用 NoneBug 的 `test_matcher` 可以模拟出一个事件流程。

如下是一个简单的示例。

<CodeBlock className="language-python" title="test_weather.py">{WeatherTest}</CodeBlock>

<details>
  <summary>示例插件</summary>
  <CodeBlock className="language-python" title="examples/weather.py">{WeatherSource}</CodeBlock>
</details>

在测试用例编写完成后 ，可以使用下面的命令运行单元测试。

```bash
pytest test_weather.py
```

## 测试流程

:::tip 提示
需要了解实现细节可查看源码。
:::

以上述测试为例：

Pytest 会在函数开始前通过 Fixture  [`nonebug_app`](https://github.com/nonebot/nonebug/blob/master/nonebug/fixture.py) **初始化 NoneBot2**。

随后使用 `test_matcher` 获取到 [`MatcherContext`](https://github.com/nonebot/nonebug/blob/master/nonebug/mixin/process/__init__.py) 对象，通过其提供的方法（如 `should_call_send`）将事件响应器操作等添加到队列。

在异步上下文管理器关闭时，`MatcherContext` 会调用父类的 `run_test` 方法按照队列对事件响应器进行断言（包括但不限于断言事件响应和 API 调用）。

在当前函数完成上述步骤后，Pytest 会自动销毁 Fixture NoneBot2 实例，结束测试。

其他的测试方法的流程与此大体相同，只是对象有些许差别。
